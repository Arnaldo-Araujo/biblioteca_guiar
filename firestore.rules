rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---

    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usuário logado é o "dono" do ID fornecido
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verifica se é Admin (com proteção 'exists' para não quebrar se o user não existir)
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // --- 1. REGRAS DE USUÁRIOS ---
    match /users/{userId} {
      // List: Qualquer logado pode listar (para validar CPF)
      allow list: if isAuthenticated();
      
      // Get: Dono ou Admin vê detalhes
      allow get: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Create/Update: Dono ou Admin (para promover helper/admin)
      allow create, update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Delete: Apenas o Dono pode se excluir (para encerrar conta)
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- 2. REGRAS DO CHAT (ERA ISSO QUE FALTAVA) ---
    match /chats/{chatId} {
      // O dono do chat (usuário comum) ou o Admin podem ler e escrever no documento do chat
      allow read, write: if isAuthenticated() && (request.auth.uid == chatId || isAdmin());

      // Regras para as mensagens dentro do chat (Subcoleção)
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && (request.auth.uid == chatId || isAdmin());
      }
    }

    // --- 3. REGRAS DE LIVROS ---
    match /books/{bookId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- 4. REGRAS DE EMPRÉSTIMOS ---
    match /loans/{loanId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // --- 5. REGRAS DE TICKETS (NOVA REGRA DE NEGÓCIO) ---
    match /tickets/{ticketId} {
      // Create: Usuários autenticados podem abrir tickets
      allow create: if isAuthenticated();
      
      // Read/Update: 
      // 1. Dono do ticket (userId)
      // 2. Helper atribuído (assigneeId)
      // 3. Admin
      allow read, update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.assigneeId == request.auth.uid || 
        isAdmin()
      );
    }

    // --- 5. REGRAS DE WAITLIST ---
    match /waitlist/{entryId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Bloqueia qualquer outra coisa não declarada acima
    match /{document=**} {
      allow read, write: if false;
    }
  }
}