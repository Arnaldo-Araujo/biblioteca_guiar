rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---

    // Verifica se o usuário está autenticado no Firebase Auth
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usuário logado é o "dono" do ID fornecido
    // Útil para garantir que o usuário só mexa nos próprios dados
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verifica se o usuário logado possui a flag 'isAdmin' como true no Firestore
    // Usa 'exists' para evitar erros caso o documento do usuário ainda não exista
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // --- REGRAS POR COLEÇÃO ---

    // Regra: O usuário só pode escrever na coleção 'users' se o ID do documento for igual ao seu UID.
    match /users/{userId} {
      // Permite ler detalhes (GET) apenas se for o dono ou admin
      allow get: if isOwner(userId) || isAdmin();
      
      // Permite listar/pesquisar (LIST) se estiver autenticado (Necessário para verificar unicidade de CPF)
      allow list: if isAuthenticated();

      // (CREATE) Criar: Apenas o dono ou admin
      allow create: if isOwner(userId) || isAdmin();

      // (UPDATE) Editar: Dono pode editar a si mesmo. Admin pode editar APENAS se o alvo NÃO for Admin.
      // Isso impede que um admin delete/desative outro admin.
      allow update: if isOwner(userId) || (isAdmin() && resource.data.isAdmin == false);
    }

    // 2. COLEÇÃO BOOKS
    // Leitura liberada para autenticados. Escrita restrita a Admins.
    match /books/{bookId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 3. COLEÇÃO LOANS (Empréstimos)
    match /loans/{loanId} {
      // Ler: Se for o dono do empréstimo OU Admin
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      
      // Criar: Qualquer autenticado (o app deve garantir que o userId gravado seja o correto)
      allow create: if isAuthenticated(); 
      
      // Atualizar: Dono (ex: reservar/cancelar) OU Admin (ex: aprovar/devolver)
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // 4. COLEÇÃO WAITLIST (Fila de Espera)
    match /waitlist/{entryId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
  }
}
